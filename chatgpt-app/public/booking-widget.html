<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>eTabeb Booking</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
      overflow-y: auto;
      overflow-x: hidden;
      color: #fff;
    }
    
    #booking-container {
      width: 100%;
      min-height: 100vh;
      padding: 0;
      background: transparent;
    }
    
    .header {
      text-align: center;
      padding: 24px 20px;
      background: transparent;
      border-bottom: none;
    }
    
    .logo {
      width: 140px;
      height: auto;
      margin-bottom: 12px;
    }
    
    .header h1 {
      color: #3EBFA5;
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .header p {
      color: #94a3b8;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #2d3748;
      padding: 6px 14px;
      border-radius: 20px;
    }
    
    .content {
      background: transparent;
      padding: 0 20px 24px;
      max-width: 100%;
      margin: 0;
    }
    
    .search-box {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    input[type="text"], input[type="tel"] {
      flex: 1;
      padding: 14px 16px;
      border: 1px solid #2d3748;
      border-radius: 12px;
      font-size: 15px;
      background: #2d3748;
      color: #fff;
      transition: all 0.3s;
    }
    
    input:focus {
      outline: none;
      border-color: #3EBFA5;
      background: #374151;
    }
    
    input::placeholder {
      color: #64748b;
    }
    
    .btn {
      padding: 14px 28px;
      background: #1976B2;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.3s;
    }
    
    .btn:hover {
      background: #1565C0;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(25, 118, 178, 0.3);
    }
    
    .btn-secondary {
      background: #f5f5f5;
      color: #333;
      padding: 10px 20px;
      font-size: 14px;
    }
    
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    
    /* Booking.com-style results row */
    .doctor-grid-wrapper {
      position: relative;
      margin: 0 -20px;
      padding: 0 20px;
    }

    .doctor-grid {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 8px 0 16px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.2) transparent;
      scroll-behavior: smooth;
    }

    .scroll-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .scroll-arrow:hover {
      background: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transform: translateY(-50%) scale(1.05);
    }

    .scroll-arrow.left {
      left: 10px;
    }

    .scroll-arrow.right {
      right: 10px;
    }

    .scroll-arrow svg {
      width: 20px;
      height: 20px;
      fill: #1a1a1a;
    }

    /* RTL support for Arabic */
    html[dir="rtl"] body { direction: rtl; text-align: right; }
    html[dir="rtl"] .results-header { flex-direction: row-reverse; }
    html[dir="rtl"] .search-box { direction: rtl; }
    html[dir="rtl"] input { text-align: right; }
    html[dir="rtl"] .doctor-availability { left: 12px; right: auto; }
    html[dir="rtl"] .scroll-arrow.left { left: auto; right: 10px; }
    html[dir="rtl"] .scroll-arrow.right { right: auto; left: 10px; }
    html[dir="rtl"] .scroll-arrow svg { transform: scaleX(-1); }

    .scroll-arrow.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .doctor-grid::-webkit-scrollbar { 
      height: 6px;
    }
    .doctor-grid::-webkit-scrollbar-track {
      background: transparent;
    }
    .doctor-grid::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 999px;
    }
    .doctor-grid::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Card container */
    .doctor-accordion {
      scroll-snap-align: start;
      flex: 0 0 280px;
      min-width: 280px;
      max-width: 280px;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      transition: all 0.25s;
      position: relative;
    }

    .doctor-accordion:hover {
      border-color: rgba(62, 191, 165, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      background: rgba(255, 255, 255, 0.12);
    }

    /* Clickable card */
    .doctor-card {
      cursor: pointer;
      display: block;
    }

    .doctor-image {
      width: 100%;
      height: 160px;
      object-fit: cover;
      display: block;
      background: rgba(0, 0, 0, 0.2);
    }

    .doctor-card-body {
      padding: 12px 14px 14px;
    }

    .doctor-name {
      font-weight: 800;
      color: #fff;
      font-size: 16px;
      line-height: 1.25;
      margin-bottom: 6px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .doctor-specialty {
      color: #3EBFA5;
      font-size: 13px;
      margin-bottom: 8px;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .doctor-facility {
      color: #94a3b8;
      font-size: 12.5px;
      margin-bottom: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      white-space: normal;
      line-height: 1.4;
    }

    .doctor-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
    }

    .doctor-rating {
      color: #fbbf24;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(251, 191, 36, 0.15);
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 12px;
      white-space: nowrap;
    }

    .doctor-price {
      color: #3EBFA5;
      font-weight: 800;
      font-size: 14px;
      white-space: nowrap;
    }

    .doctor-availability {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(62, 191, 165, 0.95);
      color: #fff;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      backdrop-filter: blur(8px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .doctor-cta {
      margin-top: 12px;
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: #1976B2;
      color: #fff;
      font-weight: 800;
      font-size: 14px;
      transition: all 0.2s;
    }

    .doctor-cta:hover {
      background: #1565C0;
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(25, 118, 178, 0.25);
    }
    
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .results-header h3 {
      color: #fff;
      font-size: 20px;
      font-weight: 700;
    }
    
    .results-count {
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      background: rgba(255, 255, 255, 0.08);
      padding: 5px 12px;
      border-radius: 16px;
    }
    
    .doctor-accordion {
      margin-bottom: 16px;
      border-radius: 16px;
      overflow: hidden;
      background: #243447;
      border: 1px solid #2d3748;
      transition: all 0.3s;
    }
    
    .doctor-accordion:hover {
      border-color: #3EBFA5;
    }
    
    .doctor-details {
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      animation: slideDown 0.3s ease-out;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        max-height: 0;
      }
      to {
        opacity: 1;
        max-height: 1000px;
      }
    }
    
    .date-btn {
      padding: 18px 16px;
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      min-width: 110px;
    }
    
    .date-btn:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(62, 191, 165, 0.5);
      transform: translateY(-2px);
    }
    
    .date-btn.active {
      background: #3EBFA5;
      border-color: #3EBFA5;
      box-shadow: 0 4px 12px rgba(62, 191, 165, 0.3);
    }
    
    .date-btn .date-day {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 6px;
      font-weight: 500;
    }
    
    .date-btn.active .date-day {
      color: rgba(255, 255, 255, 0.95);
    }
    
    .date-btn .date-number {
      font-size: 20px;
      font-weight: 800;
      color: #fff;
      margin-bottom: 6px;
    }
    
    .date-btn .date-slots {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      font-weight: 600;
    }
    
    .date-btn.active .date-slots {
      color: #fff;
    }
    
    .date-group {
      margin-bottom: 24px;
    }
    
    .date-accordion {
      margin-bottom: 12px;
    }
    
    .date-header-btn {
      width: 100%;
      padding: 16px;
      background: #243447;
      border: 1px solid #2d3748;
      border-radius: 12px;
      color: #fff;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
      font-size: 15px;
      font-weight: 600;
    }
    
    .date-header-btn:hover {
      background: #2d3f54;
      border-color: #3EBFA5;
    }
    
    .date-header-btn.active {
      background: #3EBFA5;
      border-color: #3EBFA5;
      border-radius: 12px 12px 0 0;
    }
    
    .date-content {
      display: none;
      background: #243447;
      border: 1px solid #2d3748;
      border-top: none;
      border-radius: 0 0 12px 12px;
      padding: 16px;
    }
    
    .date-content.active {
      display: block;
    }
    
    .timeslot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .timeslot-card {
      padding: 14px 18px;
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 15px;
      font-weight: 600;
      text-align: center;
    }
    
    .timeslot-card:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(62, 191, 165, 0.5);
      transform: translateY(-1px);
    }
    
    .timeslot-card.selected {
      background: #3EBFA5;
      border-color: #3EBFA5;
      color: #fff;
      box-shadow: 0 4px 12px rgba(62, 191, 165, 0.3);
    }
    
    .timeslot-time {
      font-weight: 600;
      color: #fff;
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .patient-card {
      padding: 14px;
      border: 2px solid #E0E0E0;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .patient-card:hover, .patient-card.selected {
      border-color: #1976B2;
      background: #F5F9FC;
    }
    
    .patient-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    
    .patient-id {
      color: #888;
      font-size: 13px;
    }
    
    .success-message {
      text-align: center;
      padding: 40px 20px;
    }
    
    .success-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
    
    .success-title {
      color: #3EBFA5;
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .success-text {
      color: #666;
      font-size: 15px;
    }
    
    .loading {
      text-align: center;
      color: #94a3b8;
      padding: 40px;
      font-size: 16px;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .error {
      background: #FEE;
      border: 2px solid #F88;
      color: #C33;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 16px;
    }
    
    .security-note {
      background: #F0F9FF;
      border-left: 4px solid #1976B2;
      padding: 12px 16px;
      margin-bottom: 20px;
      border-radius: 8px;
      font-size: 13px;
      color: #666;
    }
  </style>
  <script src="widget-translations.js"></script>
</head>
<body>
  <div id="booking-container"></div>
  
  <script>
    console.log('üîÑ Widget Version: 2026-02-02-v2 - Arabic RTL Fixes');
    const container = document.getElementById('booking-container');
    const baseUrl = '{{BOOKING_APP_URL}}';
    
    // Arabic mode detection
    function hasArabic(s) { return /[\u0600-\u06FF]/.test((s || '').trim()); }
    
    let SEARCH_TEXT = (window.WIDGET_PARAMS?.searchText || '').trim();
    let AR_MODE = 
      (window.WIDGET_PARAMS?.lang === 'ar') ||
      hasArabic(SEARCH_TEXT) ||
      ((navigator.language || '').toLowerCase().startsWith('ar'));
    
    // Function to update Arabic mode when searchText changes
    function updateArabicMode(newSearchText) {
      SEARCH_TEXT = newSearchText;
      AR_MODE = 
        (window.WIDGET_PARAMS?.lang === 'ar') ||
        hasArabic(SEARCH_TEXT) ||
        ((navigator.language || '').toLowerCase().startsWith('ar'));
      
      document.documentElement.lang = AR_MODE ? 'ar' : 'en';
      document.documentElement.dir = AR_MODE ? 'rtl' : 'ltr';
      
      console.log('[LANG UPDATED]', { AR_MODE, SEARCH_TEXT, injectedLang: window.WIDGET_PARAMS?.lang });
    }
    
    document.documentElement.lang = AR_MODE ? 'ar' : 'en';
    document.documentElement.dir = AR_MODE ? 'rtl' : 'ltr';
    
    console.log('[LANG]', { AR_MODE, SEARCH_TEXT, injectedLang: window.WIDGET_PARAMS?.lang });
    
    // Helper to pick OTE field when Arabic mode is ON
    function pick(eng, ote) {
      const v = AR_MODE ? (ote ?? eng) : (eng ?? ote);
      return (v ?? '').toString().trim();
    }
    
    // State management
    let doctors = [];
    let selectedDoctor = null;
    let timeslots = [];
    let currentSessionId = null; // Store sessionId globally
    let countryCodes = []; // Store country codes from API
    
    // Check if a value is a template placeholder like {{searchText}}
    function isTemplatePlaceholder(value) {
      if (typeof value !== 'string') return false;
      const v = value.trim();
      return v.startsWith('{{') && v.endsWith('}}');
    }

    // Get searchText from MCP context when outputTemplate substitution fails
    async function getSearchTextFromMcpContext() {
      try {
        if (!window.openai || typeof window.openai.callTool !== 'function') return '';
        const resp = await window.openai.callTool('get_search_context', {});
        const textItem = resp?.content?.find?.(c => c?.type === 'text');
        if (!textItem?.text) return '';
        const parsed = JSON.parse(textItem.text);
        return (parsed?.searchText || '').trim();
      } catch (e) {
        console.error('get_search_context failed:', e);
        return '';
      }
    }

    // Normalize preloaded doctors injected by the MCP server
    function getPreloadedDoctors() {
      let preloaded = window.PRELOADED_DOCTORS_DATA;

      // Some runtimes inject as a JSON string
      if (typeof preloaded === 'string') {
        try { preloaded = JSON.parse(preloaded); } catch { /* ignore */ }
      }

      // Some backends may wrap results
      if (preloaded && typeof preloaded === 'object' && !Array.isArray(preloaded)) {
        if (Array.isArray(preloaded.doctors)) return preloaded.doctors;
        if (Array.isArray(preloaded.items)) return preloaded.items;
      }

      return Array.isArray(preloaded) ? preloaded : [];
    }

    // Fetch doctors directly from the official API (CSP already allows etapisd.etabeb.com)
    async function searchDoctorsFromApi(searchText) {
      const q = (searchText || '').trim();
      if (!q) return [];

      const res = await fetch('https://etapisd.etabeb.com/api/AI/DoctorList', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ searchText: q })
      });

      const data = await res.json();
      if (!Array.isArray(data)) return [];
      
      console.log('API returned doctors:', data.length);
      console.log('First doctor RAW from API:', data[0]);
      console.log('First doctor has OTE fields?', {
        doctorNameOTE: data[0]?.doctorNameOTE,
        medicalSpecialityTextOTE: data[0]?.medicalSpecialityTextOTE,
        medicalFacilityNameOTE: data[0]?.medicalFacilityNameOTE
      });
      
      // Deduplicate doctors by DoctorId and merge facilities/specialties
      const doctorMap = new Map();
      data.forEach((doctor, idx) => {
        const doctorId = doctor.doctorId;
        console.log(`Processing doctor ${idx}:`, doctorId, doctor.medicalSpecialityText);
        if (!doctorMap.has(doctorId)) {
          // First occurrence - initialize with arrays for facilities and specialties
          doctorMap.set(doctorId, {
            ...doctor,
            facilities: [{
              facilityId: doctor.medicalFacilityId,
              facilityName: doctor.medicalFacilityName,
              facilityNameOTE: doctor.medicalFacilityNameOTE,
              specialties: [{
                specialtyId: doctor.medicalSpecialityId,
                specialtyText: doctor.medicalSpecialityText,
                specialtyTextOTE: doctor.medicalSpecialityTextOTE,
                rtId: doctor.medicalFacilityDoctorSpecialityRTId,
                timeslotCount: doctor.timeslotCount || 0
              }]
            }]
          });
        } else {
          // Duplicate doctor - merge facility and specialty
          console.log('Found duplicate doctor:', doctorId, 'adding specialty:', doctor.medicalSpecialityText);
          const existingDoctor = doctorMap.get(doctorId);
          const facilityIndex = existingDoctor.facilities.findIndex(
            f => f.facilityId === doctor.medicalFacilityId
          );
          console.log('Facility index:', facilityIndex);
          
          if (facilityIndex === -1) {
            // New facility for this doctor
            existingDoctor.facilities.push({
              facilityId: doctor.medicalFacilityId,
              facilityName: doctor.medicalFacilityName,
              facilityNameOTE: doctor.medicalFacilityNameOTE,
              specialties: [{
                specialtyId: doctor.medicalSpecialityId,
                specialtyText: doctor.medicalSpecialityText,
                specialtyTextOTE: doctor.medicalSpecialityTextOTE,
                rtId: doctor.medicalFacilityDoctorSpecialityRTId,
                timeslotCount: doctor.timeslotCount || 0
              }]
            });
          } else {
            // Existing facility - check if specialty is new (by text, not ID)
            const facility = existingDoctor.facilities[facilityIndex];
            const specialtyExists = facility.specialties.some(
              s => s.specialtyText === doctor.medicalSpecialityText
            );
            console.log('Specialty exists?', specialtyExists, 'Current specialties:', facility.specialties.map(s => s.specialtyText));
            if (!specialtyExists) {
              console.log('Adding new specialty to existing facility:', doctor.medicalSpecialityText);
              facility.specialties.push({
                specialtyId: doctor.medicalSpecialityId,
                specialtyText: doctor.medicalSpecialityText,
                specialtyTextOTE: doctor.medicalSpecialityTextOTE,
                rtId: doctor.medicalFacilityDoctorSpecialityRTId,
                timeslotCount: doctor.timeslotCount || 0
              });
            }
          }
        }
      });
      
      const deduplicated = Array.from(doctorMap.values());
      console.log('Deduplicated doctors:', deduplicated.length, 'unique from', data.length, 'total');
      return deduplicated;
    }
    
    // Fetch country codes on load
    async function fetchCountryCodes() {
      try {
        const response = await fetch('https://etapisd.etabeb.com/api/AI/CountryListForContact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const data = await response.json();
        console.log('Country API Response:', data);
        
        // The API returns an array directly
        if (Array.isArray(data)) {
          // Map API response to our format: value -> countryId, text -> countryKey, text1 -> countryName
          countryCodes = data.map(country => ({
            countryId: country.value,
            countryKey: country.text,
            countryName: country.text1 || country.text2
          }));
        } else {
          console.warn('Unexpected country data format:', data);
          countryCodes = [];
        }
        
        console.log('Country codes loaded:', countryCodes.length, 'countries');
        
        // If no countries loaded, use fallback
        if (countryCodes.length === 0) {
          console.warn('No countries from API, using fallback');
          countryCodes = [
            { countryId: 1, countryName: 'Saudi Arabia', countryKey: '+966' },
            { countryId: 2, countryName: 'UAE', countryKey: '+971' },
            { countryId: 3, countryName: 'Kuwait', countryKey: '+965' }
          ];
        }
      } catch (err) {
        console.error('Failed to load country codes:', err);
        // Fallback to default countries
        countryCodes = [
          { countryId: 1, countryName: 'Saudi Arabia', countryKey: '+966' },
          { countryId: 2, countryName: 'UAE', countryKey: '+971' },
          { countryId: 3, countryName: 'Kuwait', countryKey: '+965' }
        ];
      }
    }
    
    // Helper: Get doctor initials for avatar
    function getInitials(name) {
      return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    }
    
    // Helper: Generate avatar color
    function getAvatarColor(name) {
      const colors = ['#1976B2', '#3EBFA5', '#9C27B0', '#FF9800', '#E91E63'];
      const index = name.length % colors.length;
      return colors[index];
    }
    
    function renderDoctorResults() {
      const doctorCount = doctors.length;
      const searchText = SEARCH_TEXT || 'doctors';
      
      container.innerHTML = `
        <div class="header">
          <img src="https://e-tabeb-chat-gpt-p.vercel.app/etabeb-logo.png?v=2" alt="eTabeb" class="logo" style="height: 60px; width: auto; margin: 0 auto 16px; display: block;" />
          <h1>${AR_MODE ? 'ÿ≠ÿ¨ÿ≤ ŸÖŸàÿπÿØ' : 'Book Appointment'}</h1>
        </div>
        <div class="content">
          <div class="results-header">
            <h3>${AR_MODE ? `ÿßŸÑÿ£ÿ∑ÿ®ÿßÿ° ÿßŸÑŸÖÿ™ÿßÿ≠ŸàŸÜ ${searchText}` : `Available ${searchText} Doctors`}</h3>
            <span class="results-count">${AR_MODE ? `ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${doctorCount} ÿ∑ÿ®Ÿäÿ®` : `${doctorCount} doctors found`}</span>
          </div>
          <div style="color:#94a3b8;font-size:13px;margin:6px 0 14px;">
            ${AR_MODE ? 'ŸÖÿ±ÿ± ŸÑŸÑÿ™ÿµŸÅÿ≠. ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ® ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖŸàÿßÿπŸäÿØ.' : 'Scroll to browse. Tap a doctor card to view timeslots.'}
          </div>
          <div id="doctor-list"></div>
        </div>
      `;
      
      renderDoctorCards();
    }
    
    function renderDoctorCards() {
      const doctorList = document.getElementById('doctor-list');
      if (!doctorList) return;
      
      console.log('=== RENDERING DOCTORS ===');
      console.log('AR_MODE:', AR_MODE);
      console.log('First doctor:', doctors[0]);
      
      doctorList.innerHTML = `
      <div class="doctor-grid-wrapper">
        <button class="scroll-arrow left" id="scroll-left" onclick="scrollDoctors('left')">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
          </svg>
        </button>
        <button class="scroll-arrow right" id="scroll-right" onclick="scrollDoctors('right')">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
          </svg>
        </button>
        <div class="doctor-grid" id="doctor-grid-scroll">${doctors.map((doctor, index) => {
        const img = doctor.picURL01 || 'https://e-tabeb-chat-gpt-p.vercel.app/etabeb-logo.png';
        const name = pick(doctor.doctorName, doctor.doctorNameOTE) || 'Doctor';
        const rating = doctor.ratingAvg || doctor.ratingText || (AR_MODE ? 'ÿ¨ÿØŸäÿØ' : 'New');
        const price = (doctor.priceRateMin ?? '0');
        const currency = doctor.currencyCode || 'SAR';
        
        // Calculate total slots from all facilities/specialties
        let totalSlots = 0;
        if (doctor.facilities && Array.isArray(doctor.facilities)) {
          doctor.facilities.forEach(fac => {
            fac.specialties.forEach(spec => {
              totalSlots += spec.timeslotCount || 0;
            });
          });
        } else {
          totalSlots = doctor.timeslotCount || 0;
        }
        
        // Determine facility and specialty display
        let facility = '';
        let specialty = '';
        
        if (doctor.facilities && doctor.facilities.length > 0) {
          // Check if multiple facilities
          if (doctor.facilities.length > 1) {
            facility = AR_MODE ? 'ŸÖŸÜÿ¥ÿ¢ÿ™ ŸÖÿ™ÿπÿØÿØÿ©' : 'Multi Facility';
          } else {
            facility = pick(doctor.facilities[0].facilityName, doctor.facilities[0].facilityNameOTE);
          }
          
          // Get all unique specialties across all facilities
          const allSpecialties = [];
          doctor.facilities.forEach(fac => {
            fac.specialties.forEach(spec => {
              const specText = pick(spec.specialtyText, spec.specialtyTextOTE);
              if (!allSpecialties.includes(specText)) {
                allSpecialties.push(specText);
              }
            });
          });
          
          // Show all specialties - each on separate line if multiple
          if (allSpecialties.length > 1) {
            specialty = allSpecialties.map(s => `‚Ä¢ ${s}`).join('<br>');
          } else {
            specialty = allSpecialties[0] || (AR_MODE ? 'ÿßŸÑÿ™ÿÆÿµÿµ' : 'Specialty');
          }
        } else {
          facility = pick(doctor.medicalFacilityName, doctor.medicalFacilityNameOTE);
          specialty = pick(doctor.medicalSpecialityText, doctor.medicalSpecialityTextOTE) || (AR_MODE ? 'ÿßŸÑÿ™ÿÆÿµÿµ' : 'Specialty');
        }
        
        const slots = totalSlots;
        
        // Calculate nearest appointment date
        // Use nearestAvailable field from API or fallback to other fields
        let nearestDate = '';
        const nearestAvailableText = doctor.nearestAvailable;
        
        if (nearestAvailableText) {
          if (AR_MODE) {
            // Translate common patterns to Arabic
            if (/Today/i.test(nearestAvailableText)) {
              nearestDate = 'ÿßŸÑŸäŸàŸÖ';
            } else if (/Tomorrow/i.test(nearestAvailableText)) {
              nearestDate = 'ÿ∫ÿØÿßŸã';
            } else {
              const afterDaysMatch = nearestAvailableText.match(/After (\d+) Days?/i);
              if (afterDaysMatch) {
                const days = afterDaysMatch[1];
                nearestDate = `ÿ®ÿπÿØ ${days} ${days === '1' ? 'ŸäŸàŸÖ' : 'ÿ£ŸäÿßŸÖ'}`;
              } else {
                nearestDate = nearestAvailableText;
              }
            }
          } else {
            nearestDate = nearestAvailableText;
          }
        } else {
          // Fallback: Try multiple possible field names from API
          const nextDateField = doctor.nextAvailableDate || doctor.nextAvailableAppointment || doctor.nearestDate || doctor.firstAvailableDate;
          
          if (nextDateField) {
            const dateObj = new Date(nextDateField);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (dateObj.toDateString() === today.toDateString()) {
              nearestDate = AR_MODE ? 'ŸÖÿ™ÿßÿ≠ ÿßŸÑŸäŸàŸÖ' : 'Available Today';
            } else if (dateObj.toDateString() === tomorrow.toDateString()) {
              nearestDate = AR_MODE ? 'ŸÖÿ™ÿßÿ≠ ÿ∫ÿØÿßŸã' : 'Available Tomorrow';
            } else {
              const formattedDate = dateObj.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
              nearestDate = AR_MODE ? `ŸÖÿ™ÿßÿ≠ ${formattedDate}` : `Available ${formattedDate}`;
            }
          } else if (index === 0) {
            // Log first doctor's fields to debug
            console.log('Doctor fields:', Object.keys(doctor));
            console.log('Full doctor object:', doctor);
          }
        }

        return `
          <div class="doctor-accordion" id="doctor-${index}">
            <div class="doctor-availability">${slots} ${window.t ? window.t('slots') : 'slots'}</div>

            <div class="doctor-card" onclick="toggleDoctorDetails(${index})">
              <img class="doctor-image"
                   src="${img}"
                   alt="${name}"
                   onerror="this.src='https://e-tabeb-chat-gpt-p.vercel.app/etabeb-logo.png'">

              <div class="doctor-card-body">
                <div class="doctor-name">${name}</div>
                <div class="doctor-specialty" style="line-height: 1.6;">${specialty}</div>
                <div class="doctor-facility">${facility}</div>
                ${nearestDate ? `<div style="color: #3EBFA5; font-size: 13px; margin-top: 4px; font-weight: 600;">${AR_MODE ? 'ÿ£ŸÇÿ±ÿ® ŸÖŸàÿπÿØ:' : 'Nearest Appt:'} ${nearestDate}</div>` : ''}

                <div class="doctor-meta">
                  <span class="doctor-rating">${rating}</span>
                  ${price && price !== '0' ? `<span class="doctor-price">${price} ${currency}</span>` : ''}
                </div>

                <button class="doctor-cta" type="button">${
                  doctor.facilities && doctor.facilities.length > 1 
                    ? (AR_MODE ? 'ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ¥ÿ£ÿ©' : 'Select Facility')
                    : (doctor.facilities && doctor.facilities.length > 0 && doctor.facilities[0].specialties.length > 1)
                      ? (AR_MODE ? 'ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿÆÿµÿµ' : 'Select Specialty')
                      : (AR_MODE ? 'ÿπÿ±ÿ∂ ÿßŸÑŸÖŸàÿßÿπŸäÿØ' : 'View Timeslots')
                }</button>
              </div>
            </div>

            <div class="doctor-details" id="details-${index}"></div>
          </div>
        `;
      }).join('')}</div>
      </div>`;
      
      // Add scroll event listener to show/hide arrows
      setTimeout(() => {
        const grid = document.getElementById('doctor-grid-scroll');
        const leftArrow = document.getElementById('scroll-left');
        const rightArrow = document.getElementById('scroll-right');
        
        if (grid && leftArrow && rightArrow) {
          const updateArrows = () => {
            const scrollLeft = grid.scrollLeft;
            const maxScroll = grid.scrollWidth - grid.clientWidth;
            
            leftArrow.classList.toggle('hidden', scrollLeft <= 0);
            rightArrow.classList.toggle('hidden', scrollLeft >= maxScroll - 1);
          };
          
          grid.addEventListener('scroll', updateArrows);
          updateArrows();
        }
      }, 100);
    }
    
    function renderSearchUI() {
      container.innerHTML = `
        <div class="header">
          <img 
            src="https://e-tabeb-chat-gpt-p.vercel.app/etabeb-logo.png?v=2" 
            alt="eTabeb" 
            class="logo"
            style="height: 60px; width: auto; margin: 0 auto 16px; display: block;"
          />
          <h1>Book Appointment</h1>
        </div>
        <div class="content">
          <div style="background: #243447; border-radius: 16px; padding: 20px; margin-bottom: 24px;">
            <div style="margin-bottom: 16px;">
              <h3 style="color: #fff; margin: 0; font-size: 18px;">Select Doctor</h3>
            </div>
            <div class="search-box">
              <input 
                type="text" 
                id="search-input" 
                placeholder="Search by name, specialty, or hospital..."
              />
              <button id="search-btn" class="btn">Search</button>
            </div>
          </div>
          <div id="results"></div>
        </div>
      `;
      
      document.getElementById('search-btn').onclick = handleSearch;
      document.getElementById('search-input').onkeypress = (e) => {
        if (e.key === 'Enter') handleSearch();
      };
    }
    
    async function handleSearch() {
      const searchText = document.getElementById('search-input').value.trim();
      if (!searchText) return;

      document.getElementById('results').innerHTML = '<div class="loading">Searching...</div>';

      try {
        doctors = await searchDoctorsFromApi(searchText);

        // Render Booking.com-style cards
        if (doctors.length > 0) {
          window.WIDGET_PARAMS = window.WIDGET_PARAMS || {};
          window.WIDGET_PARAMS.searchText = searchText;
          renderDoctorResults();
        } else {
          document.getElementById('results').innerHTML = '<div class="loading">No doctors found</div>';
        }
      } catch (err) {
        document.getElementById('results').innerHTML =
          `<p style="color: #d32f2f; text-align: center;">Error: ${err.message}</p>`;
      }
    }
    
    function renderDoctors() {
      if (!doctors || doctors.length === 0) {
        document.getElementById('results').innerHTML = '<div class="loading">No doctors found</div>';
        return;
      }
      
      const html = doctors.map(d => {
        const initials = getInitials(d.name);
        const avatarColor = getAvatarColor(d.name);
        const hasImage = d.image && d.image.trim() !== '';
        
        const avatarHtml = hasImage 
          ? `<img src="${d.image}" alt="${d.name}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; flex-shrink: 0;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
             <div style="width: 48px; height: 48px; border-radius: 50%; background: ${avatarColor}; display: none; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 16px; flex-shrink: 0;">
               ${initials}
             </div>`
          : `<div style="width: 48px; height: 48px; border-radius: 50%; background: ${avatarColor}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 16px; flex-shrink: 0;">
               ${initials}
             </div>`;
        
        return `
          <div class="doctor-card" onclick="selectDoctor('${d.id}')">
            <div style="display: flex; gap: 12px; margin-bottom: 12px;">
              ${avatarHtml}
              <div style="flex: 1; min-width: 0;">
                <div class="doctor-name">${d.name}</div>
                <div class="doctor-specialty">${d.specialty}</div>
              </div>
            </div>
            <div class="doctor-facility">üìç ${d.facility}</div>
            <div class="doctor-meta">
              <span class="doctor-rating">‚≠ê ${d.rating || '0'}</span>
              <span class="doctor-price">${d.price} ${d.currency}</span>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('results').innerHTML = `<div class="doctor-grid">${html}</div>`;
    }
    
    window.selectDoctor = async function(doctorId) {
      selectedDoctor = doctors.find(d => d.id === doctorId);
      if (!selectedDoctor) return;
      
      document.getElementById('results').innerHTML = '<p style="text-align: center; color: #666;">Loading timeslots...</p>';
      
      try {
        // Call private get_timeslots tool
        await window.openai.callTool('get_timeslots', {
          doctorId: doctorId
        });
        
        // Fetch timeslots from API
        const response = await fetch(`${baseUrl}/api/timeslots`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ medicalFacilityDoctorSpecialityRTId: doctorId })
        });
        timeslots = await response.json();
        
        renderTimeslots();
      } catch (err) {
        document.getElementById('results').innerHTML = `<p style="color: #d32f2f; text-align: center;">Error: ${err.message}</p>`;
      }
    };
    
    let selectedDate = null;
    
    // Helper function to extract start time from time range
    // API already sends times in 12-hour format with AM/PM (e.g., "5:50 AM - 6:00 AM")
    function formatTime12Hour(timeStr) {
      if (!timeStr) return timeStr;
      
      // If it's a range (e.g., "5:50 AM - 6:00 AM"), extract just the start time
      if (timeStr.includes(' - ')) {
        return timeStr.split(' - ')[0].trim();
      }
      
      // Otherwise return as-is (already formatted)
      return timeStr;
    }
    
    function renderTimeslotsInline(doctorIndex) {
      const detailsDiv = document.getElementById(`details-${doctorIndex}`);
      if (!timeslots || !Array.isArray(timeslots) || timeslots.length === 0) {
        detailsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #94a3b8;">No available appointments</div>';
        return;
      }
      
      // Group timeslots by date
      const grouped = {};
      timeslots.forEach(slot => {
        if (!grouped[slot.date]) grouped[slot.date] = [];
        grouped[slot.date].push(slot);
      });
      
      // Sort dates chronologically (earliest first)
      const dates = Object.keys(grouped).sort((a, b) => {
        return new Date(a) - new Date(b);
      }).slice(0, 5);
      if (!selectedDate && dates.length > 0) selectedDate = dates[0];
      
      const dateButtons = dates.map((date, idx) => {
        const dateObj = new Date(date);
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        let dayLabel;
        if (dateObj.toDateString() === today.toDateString()) {
          dayLabel = 'Today';
        } else if (dateObj.toDateString() === tomorrow.toDateString()) {
          dayLabel = 'Tomorrow';
        } else {
          dayLabel = dateObj.toLocaleDateString('en-US', {weekday: 'short'});
        }
        
        return `
          <button onclick="selectDate('${date}', ${doctorIndex})" class="date-btn ${date === selectedDate ? 'active' : ''}" id="date-btn-${date}">
            <div class="date-day">${dayLabel}</div>
            <div class="date-number">${dateObj.getDate()}</div>
            <div class="date-slots">${grouped[date].length} slots</div>
          </button>
        `;
      }).join('');
      
      const slots = grouped[selectedDate].map(slot => {
        const formattedTime = formatTime12Hour(slot.time);
        return `
          <div class="timeslot-card" onclick="selectTimeslot(${slot.timeslotRTId}, '${slot.date}', '${formattedTime}', ${doctorIndex})">
            <div class="timeslot-time">${formattedTime}</div>
          </div>
        `;
      }).join('');
      
      detailsDiv.innerHTML = `
        <div style="padding: 20px; background: #1a2332; border-top: 1px solid #2d3748;">
          <h4 style="color: #fff; margin-bottom: 16px; font-size: 16px;">${AR_MODE ? 'ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ' : 'Select Date'}</h4>
          <div style="display: flex; gap: 12px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 8px;">
            ${dateButtons}
          </div>
          <h4 style="color: #fff; margin-bottom: 16px; font-size: 16px;">${AR_MODE ? 'ÿßŸÑÿ£ŸàŸÇÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©' : 'Available Times'}</h4>
          <div class="timeslot-grid" id="timeslot-grid-${doctorIndex}">${slots}</div>
        </div>
      `;
    }
    
    window.selectDate = function(date, doctorIndex) {
      selectedDate = date;
      document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`date-btn-${date}`).classList.add('active');
      
      const grouped = {};
      timeslots.forEach(slot => {
        if (!grouped[slot.date]) grouped[slot.date] = [];
        grouped[slot.date].push(slot);
      });
      
      const slots = grouped[date].map(slot => {
        const formattedTime = formatTime12Hour(slot.time);
        return `
          <div class="timeslot-card" onclick="selectTimeslot(${slot.timeslotRTId}, '${slot.date}', '${formattedTime}', ${doctorIndex})">
            <div class="timeslot-time">${formattedTime}</div>
          </div>
        `;
      }).join('');
      
      document.getElementById(`timeslot-grid-${doctorIndex}`).innerHTML = slots;
    };
    
    let selectedTimeslot = null;
    
    window.selectTimeslot = function(timeslotId, date, time, doctorIndex) {
      selectedTimeslot = { timeslotId, date, time };
      renderBookingFormInline(doctorIndex);
    };
    
    function renderBookingFormInline(doctorIndex) {
      const detailsDiv = document.getElementById(`details-${doctorIndex}`);
      
      detailsDiv.innerHTML = `
        <div style="padding: 24px; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.1);">
          <div style="background: rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 24px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.12);">
            <h3 style="color: #fff; margin: 0 0 20px 0; font-size: 20px; font-weight: 700;">${AR_MODE ? 'ŸÖŸÑÿÆÿµ ÿßŸÑÿ≠ÿ¨ÿ≤' : 'Booking Summary'}</h3>
            
            <div style="display: flex; flex-direction: column; gap: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                  <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 4px;">${AR_MODE ? 'ÿßŸÑÿ∑ÿ®Ÿäÿ®' : 'Doctor'}</div>
                  <div style="color: #fff; font-size: 16px; font-weight: 600;">${pick(selectedDoctor.doctorName || selectedDoctor.name, selectedDoctor.doctorNameOTE)}</div>
                  <div style="color: #3EBFA5; font-size: 14px; margin-top: 2px;">${pick(selectedDoctor.medicalSpecialityText || selectedDoctor.specialty, selectedDoctor.medicalSpecialityTextOTE)}</div>
                </div>
                <button onclick="renderTimeslotsInline(${doctorIndex})" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #fff; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.15)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">${AR_MODE ? 'ÿ™ÿπÿØŸäŸÑ' : 'Edit'}</button>
              </div>
              
              <div style="height: 1px; background: rgba(255, 255, 255, 0.1);"></div>
              
              <div>
                <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 4px;">${AR_MODE ? 'ÿßŸÑŸÖŸÜÿ¥ÿ£ÿ©' : 'Facility'}</div>
                <div style="color: #fff; font-size: 15px;">${pick(selectedDoctor.medicalFacilityName || selectedDoctor.facility, selectedDoctor.medicalFacilityNameOTE)}</div>
              </div>
              
              <div style="height: 1px; background: rgba(255, 255, 255, 0.1);"></div>
              
              <div style="display: flex; gap: 24px;">
                <div style="flex: 1;">
                  <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 4px;">${AR_MODE ? 'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ' : 'Date'}</div>
                  <div style="color: #fff; font-size: 15px; font-weight: 600;">${selectedTimeslot.date}</div>
                </div>
                <div style="flex: 1;">
                  <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 4px;">${AR_MODE ? 'ÿßŸÑŸàŸÇÿ™' : 'Time'}</div>
                  <div style="color: #fff; font-size: 15px; font-weight: 600;">${selectedTimeslot.time}</div>
                </div>
              </div>
            </div>
          </div>
          
          <div style="background: rgba(62, 191, 165, 0.1); border: 1px solid rgba(62, 191, 165, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
            <div style="color: #3EBFA5; font-size: 14px; font-weight: 600; margin-bottom: 8px;">${AR_MODE ? 'ÿßŸÑÿÆÿ∑Ÿàÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©' : 'Next Step'}</div>
            <div style="color: rgba(255, 255, 255, 0.8); font-size: 14px; line-height: 1.5;">${AR_MODE ? 'ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅŸÉ ŸÑÿ™ŸÑŸÇŸä ÿ±ŸÖÿ≤ ÿßŸÑÿ™ÿ≠ŸÇŸÇ Ÿàÿ•ŸÉŸÖÿßŸÑ ÿ≠ÿ¨ÿ≤ŸÉ.' : 'Enter your phone number to receive an OTP and complete your booking.'}</div>
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="color: #fff; display: block; margin-bottom: 10px; font-weight: 600; font-size: 15px;">${AR_MODE ? 'ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ' : 'Phone Number'}</label>
            <div style="display: flex; gap: 12px; align-items: stretch;">
              <select id="country-select" style="padding: 14px 12px; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; background: rgba(255, 255, 255, 0.08); color: #fff; font-size: 15px; width: 100px; flex-shrink: 0; cursor: pointer;">
                ${countryCodes.map(c => `<option value="${c.countryId}">${c.countryKey}</option>`).join('')}
              </select>
              <input type="tel" id="phone-input" placeholder="5XXXXXXXX" style="flex: 1; padding: 14px 16px; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; background: rgba(255, 255, 255, 0.08); color: #fff; font-size: 15px; min-width: 0;" />
            </div>
          </div>
          
          <button onclick="sendOTP()" class="btn" style="width: 100%; padding: 16px; font-size: 16px; font-weight: 700; background: #3EBFA5; border: none; border-radius: 12px; color: #fff; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#35a892'" onmouseout="this.style.background='#3EBFA5'">${AR_MODE ? 'ŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ' : 'Continue to Verification'}</button>
          
          <div id="otp-section"></div>
        </div>
      `;
    }
    
    window.sendOTP = async function() {
      const phone = document.getElementById('phone-input').value.trim();
      const countryId = document.getElementById('country-select').value;
      const btn = event?.target || document.querySelector('button[onclick="sendOTP()"]');
      
      if (!phone) {
        alert('Please enter your phone number');
        return;
      }
      
      if (!btn) return;
      
      btn.disabled = true;
      btn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 8px;"><svg width="16" height="16" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke="white" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"/></svg> Sending...</span>';
      
      try {
        // Only search user if we don't have a sessionId yet
        if (!currentSessionId) {
          const searchRes = await fetch(`${baseUrl}/api/auth/search-user`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mobileNumber: phone, countryId: parseInt(countryId) })
          });
          const searchData = await searchRes.json();
          console.log('Search user response:', searchData);
          
          // Extract sessionId from search response and store globally
          currentSessionId = searchData.sessionId || searchData.userSessionId || searchData.userData?.userSessionId || searchData.userData?.usersSessionId;
          console.log('Extracted sessionId:', currentSessionId);
        } else {
          console.log('Using existing sessionId:', currentSessionId);
        }
        
        // Then send OTP
        const otpRes = await fetch(`${baseUrl}/api/auth/send-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mobileNumber: phone, countryId: parseInt(countryId) })
        });
        const otpData = await otpRes.json();
        
        if (otpData.signOTPId) {
          showOTPInput(otpData.signOTPId, phone);
        } else {
          btn.disabled = false;
          btn.innerHTML = 'Send OTP';
          console.error('Failed to send OTP. Please try again.');
        }
      } catch (err) {
        btn.disabled = false;
        btn.innerHTML = 'Send OTP';
        console.error('Error: ' + err.message);
      }
    };
    
    function showOTPInput(signOTPId, phone) {
      const otpSection = document.getElementById('otp-section');
      if (!otpSection) return;
      
      // Hide the send OTP button
      const sendBtn = document.querySelector('button[onclick="sendOTP()"]');
      if (sendBtn) sendBtn.style.display = 'none';
      
      otpSection.innerHTML = `
        <div style="margin-top: 20px; padding: 20px; background: rgba(62, 191, 165, 0.1); border: 1px solid rgba(62, 191, 165, 0.3); border-radius: 12px;">
          <div style="color: #3EBFA5; font-size: 14px; font-weight: 600; margin-bottom: 12px;">${AR_MODE ? 'ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ÿ≠ŸÇŸÇ!' : 'OTP Sent!'}</div>
          <div style="color: rgba(255, 255, 255, 0.8); font-size: 13px; margin-bottom: 16px;">${AR_MODE ? 'Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿáÿßÿ™ŸÅŸÉ ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ÿ≠ŸÇŸÇ.' : 'Please check your phone for the verification code.'}</div>
          
          <label style="color: #fff; display: block; margin-bottom: 10px; font-weight: 600; font-size: 15px;">${AR_MODE ? 'ÿ£ÿØÿÆŸÑ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ÿ≠ŸÇŸÇ' : 'Enter OTP Code'}</label>
          <input type="text" id="otp-input" placeholder="${AR_MODE ? 'ÿ£ÿØÿÆŸÑ ÿßŸÑÿ±ŸÖÿ≤ ÿßŸÑŸÖŸÉŸàŸÜ ŸÖŸÜ 4 ÿ£ÿ±ŸÇÿßŸÖ' : 'Enter 4-digit code'}" maxlength="4" style="width: 100%; padding: 14px 16px; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; background: rgba(255, 255, 255, 0.08); color: #fff; font-size: 15px; margin-bottom: 16px;" />
          
          <button id="verify-btn" onclick="verifyOTP('${signOTPId}', '${phone}')" style="width: 100%; padding: 16px; font-size: 16px; font-weight: 700; background: #3EBFA5; border: none; border-radius: 12px; color: #fff; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#35a892'" onmouseout="this.style.background='#3EBFA5'">${AR_MODE ? 'ÿ™ÿ≠ŸÇŸÇ ŸàŸÖÿ™ÿßÿ®ÿπÿ©' : 'Verify & Continue'}</button>
        </div>
      `;
    }
    
    window.verifyOTP = async function(signOTPId, phone) {
      const otpCode = document.getElementById('otp-input').value.trim();
      if (!otpCode) {
        console.error('Please enter OTP code');
        return;
      }
      
      try {
        const response = await fetch(`${baseUrl}/api/auth/verify-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signOTPId, signOTPCode: otpCode })
        });
        const data = await response.json();
        
        console.log('OTP Verify Response:', data);
        console.log('sessionId from verify API:', data.sessionId);
        console.log('currentSessionId (from search-user):', currentSessionId);
        
        if (data.isVerified) {
          // DO NOT update currentSessionId - keep using the one from search-user API
          // The verify-otp API returns signOTPId, not the user's sessionId
          console.log('OTP verified! Using sessionId from search-user:', currentSessionId);
          loadPatients(phone, currentSessionId);
        } else {
          console.error('Invalid OTP:', data.message || 'Please try again.');
          alert(data.message || 'Invalid OTP. Please try again.');
        }
      } catch (err) {
        console.error('Error verifying OTP:', err.message);
        alert('Error verifying OTP. Please try again.');
      }
    };
    
    async function loadPatients(phone, sessionId) {
      try {
        console.log('Loading patients with sessionId:', sessionId);
        const response = await fetch(`${baseUrl}/api/auth/patients`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: sessionId, mobileNumber: phone })
        });
        const patients = await response.json();
        console.log('Patients response:', patients);
        
        showPatientSelection(patients, phone);
      } catch (err) {
        console.error('Error loading patients: ' + err.message);
      }
    }
    
    function showPatientSelection(patients, phone) {
      if (!patients || patients.length === 0) {
        document.getElementById('otp-section').innerHTML = `
          <div style="color: #fff; text-align: center; padding: 20px;">No patients found for this number.</div>
        `;
        return;
      }
      
      const patientOptions = patients.map((p, i) => `
        <option value="${i}">${p.patientName} - ID: ${p.residentIdentities || p.patientId || 'N/A'}</option>
      `).join('');
      
      document.getElementById('otp-section').innerHTML = `
        <div style="margin-top: 20px; padding: 20px; background: rgba(62, 191, 165, 0.1); border: 1px solid rgba(62, 191, 165, 0.3); border-radius: 12px;">
          <label style="color: #fff; display: block; margin-bottom: 10px; font-weight: 600; font-size: 15px;">${AR_MODE ? 'ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ±Ÿäÿ∂' : 'Select Patient'}</label>
          <select id="patient-select" style="width: 100%; padding: 14px 16px; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; background: rgba(255, 255, 255, 0.08); color: #fff; font-size: 15px; margin-bottom: 16px; cursor: pointer;">
            <option value="" disabled selected>${AR_MODE ? '...ÿßÿÆÿ™ÿ± ŸÖÿ±Ÿäÿ∂ÿßŸã' : 'Choose a patient...'}</option>
            ${patientOptions}
          </select>
          
          <button onclick="confirmPatientSelection('${phone}')" style="width: 100%; padding: 16px; font-size: 16px; font-weight: 700; background: #3EBFA5; border: none; border-radius: 12px; color: #fff; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#35a892'" onmouseout="this.style.background='#3EBFA5'">${AR_MODE ? 'ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ¨ÿ≤' : 'Confirm Booking'}</button>
        </div>
      `;
      
      window.patientsData = patients;
      window.phoneNumber = phone;
    }
    
    window.confirmPatientSelection = async function(phone) {
      const selectEl = document.getElementById('patient-select');
      const index = parseInt(selectEl.value);
      
      if (isNaN(index) || index < 0) {
        alert('Please select a patient');
        return;
      }
      
      await selectPatient(index, phone);
    };
    
    window.scrollDoctors = function(direction) {
      const grid = document.getElementById('doctor-grid-scroll');
      if (!grid) return;
      
      const scrollAmount = 300; // Scroll by 300px
      const currentScroll = grid.scrollLeft;
      
      // In RTL mode, reverse the scroll direction
      const effectiveDirection = AR_MODE ? (direction === 'left' ? 'right' : 'left') : direction;
      
      if (effectiveDirection === 'left') {
        grid.scrollTo({
          left: currentScroll - scrollAmount,
          behavior: 'smooth'
        });
      } else {
        grid.scrollTo({
          left: currentScroll + scrollAmount,
          behavior: 'smooth'
        });
      }
    };

    window.toggleDoctorDetails = async function(index) {
      const detailsDiv = document.getElementById(`details-${index}`);
      if (!detailsDiv) return;

      const open = detailsDiv.style.display === 'block';

      // close all
      document.querySelectorAll('.doctor-details').forEach(el => el.style.display = 'none');

      if (open) return;

      const doctor = doctors[index];
      if (!doctor) return;

      selectedDoctor = doctor;
      timeslots = []; // Reset timeslots when switching doctors
      selectedDate = null; // Reset selected date

      detailsDiv.style.display = 'block';

      // Check if doctor has multiple facilities or specialties
      const hasFacilities = doctor.facilities && doctor.facilities.length > 0;
      const hasMultipleFacilities = hasFacilities && doctor.facilities.length > 1;
      
      if (hasFacilities) {
        // Check if any facility has multiple specialties
        const hasMultipleSpecialties = doctor.facilities.some(f => f.specialties.length > 1);
        
        if (hasMultipleFacilities || hasMultipleSpecialties) {
          // Show facility/specialty selection UI
          renderFacilitySpecialtySelection(index, doctor, detailsDiv);
          return;
        } else {
          // Single facility and single specialty - load timeslots directly
          const rtId = doctor.facilities[0].specialties[0].rtId;
          loadTimeslotsForDoctor(index, rtId, detailsDiv);
        }
      } else {
        // Old data format - load directly
        const doctorId = doctor.medicalFacilityDoctorSpecialityRTId || doctor.id;
        loadTimeslotsForDoctor(index, doctorId, detailsDiv);
      }
    };

    function renderFacilitySpecialtySelection(index, doctor, detailsDiv) {
      const lang = window.WIDGET_PARAMS?.language || 'en';
      const isRTL = lang === 'ar';
      
      let html = `<div style="padding: 20px; background: #1a2332; border-radius: 12px;">`;
      
      // If multiple facilities, show facility selection first
      if (doctor.facilities.length > 1) {
        html += `
          <h4 style="color: #fff; margin-bottom: 16px; ${isRTL ? 'text-align: right;' : ''}">${AR_MODE ? 'ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ¥ÿ£ÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ©' : 'Select Medical Facility'}</h4>
          <div style="display: flex; flex-direction: column; gap: 12px;">
        `;
        
        doctor.facilities.forEach((facility, fIndex) => {
          const totalSlots = facility.specialties.reduce((sum, s) => sum + (s.timeslotCount || 0), 0);
          const facilityName = pick(facility.facilityName, facility.facilityNameOTE);
          html += `
            <button onclick="selectFacility(${index}, ${fIndex})" 
                    style="padding: 16px; background: #2d3748; border: 2px solid #3EBFA5; border-radius: 12px; color: #fff; cursor: pointer; text-align: ${isRTL ? 'right' : 'left'}; transition: all 0.3s;"
                    onmouseover="this.style.background='#374151'"
                    onmouseout="this.style.background='#2d3748'">
              <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">${facilityName}</div>
              <div style="color: #94a3b8; font-size: 14px;">${totalSlots} ${AR_MODE ? 'ŸÖŸàÿßÿπŸäÿØ ŸÖÿ™ÿßÿ≠ÿ©' : 'slots available'}</div>
            </button>
          `;
        });
        
        html += `</div></div>`;
      } else {
        // Single facility with multiple specialties
        const facility = doctor.facilities[0];
        const facilityName = pick(facility.facilityName, facility.facilityNameOTE);
        html += `
          <h4 style="color: #fff; margin-bottom: 8px; ${isRTL ? 'text-align: right;' : ''}">${facilityName}</h4>
          <h5 style="color: #94a3b8; margin-bottom: 16px; font-weight: normal; ${isRTL ? 'text-align: right;' : ''}">${AR_MODE ? 'ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿÆÿµÿµ' : 'Select Specialty'}</h5>
          <div style="display: flex; flex-direction: column; gap: 12px;">
        `;
        
        facility.specialties.forEach((specialty, sIndex) => {
          const specText = pick(specialty.specialtyText, specialty.specialtyTextOTE);
          html += `
            <button onclick="selectSpecialty(${index}, 0, ${sIndex})" 
                    style="padding: 16px; background: #2d3748; border: 2px solid #3EBFA5; border-radius: 12px; color: #fff; cursor: pointer; text-align: ${isRTL ? 'right' : 'left'}; transition: all 0.3s;"
                    onmouseover="this.style.background='#374151'"
                    onmouseout="this.style.background='#2d3748'">
              <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">${specText}</div>
              <div style="color: #94a3b8; font-size: 14px;">${specialty.timeslotCount || 0} ${AR_MODE ? 'ŸÖŸàÿßÿπŸäÿØ ŸÖÿ™ÿßÿ≠ÿ©' : 'slots available'}</div>
            </button>
          `;
        });
        
        html += `</div></div>`;
      }
      
      detailsDiv.innerHTML = html;
    }

    window.selectFacility = function(doctorIndex, facilityIndex) {
      const doctor = doctors[doctorIndex];
      const facility = doctor.facilities[facilityIndex];
      const detailsDiv = document.getElementById(`details-${doctorIndex}`);
      
      if (facility.specialties.length > 1) {
        // Show specialty selection for this facility
        const lang = window.WIDGET_PARAMS?.language || 'en';
        const isRTL = lang === 'ar';
        
        let html = `<div style="padding: 20px; background: #1a2332; border-radius: 12px;">
          <button onclick="toggleDoctorDetails(${doctorIndex})" 
                  style="background: transparent; border: none; color: #3EBFA5; cursor: pointer; margin-bottom: 16px; font-size: 14px; ${isRTL ? 'float: right;' : 'float: left;'}">
            ‚Üê ${window.t ? window.t('back') : 'Back'}
          </button>
          <div style="clear: both;"></div>
          <h4 style="color: #fff; margin-bottom: 8px; ${isRTL ? 'text-align: right;' : ''}">${pick(facility.facilityName, facility.facilityNameOTE)}</h4>
          <h5 style="color: #94a3b8; margin-bottom: 16px; font-weight: normal; ${isRTL ? 'text-align: right;' : ''}">${AR_MODE ? 'ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿÆÿµÿµ' : 'Select Specialty'}</h5>
          <div style="display: flex; flex-direction: column; gap: 12px;">
        `;
        
        facility.specialties.forEach((specialty, sIndex) => {
          const specText = pick(specialty.specialtyText, specialty.specialtyTextOTE);
          html += `
            <button onclick="selectSpecialty(${doctorIndex}, ${facilityIndex}, ${sIndex})" 
                    style="padding: 16px; background: #2d3748; border: 2px solid #3EBFA5; border-radius: 12px; color: #fff; cursor: pointer; text-align: ${isRTL ? 'right' : 'left'}; transition: all 0.3s;"
                    onmouseover="this.style.background='#374151'"
                    onmouseout="this.style.background='#2d3748'">
              <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">${specText}</div>
              <div style="color: #94a3b8; font-size: 14px;">${specialty.timeslotCount || 0} ${AR_MODE ? 'ŸÖŸàÿßÿπŸäÿØ ŸÖÿ™ÿßÿ≠ÿ©' : 'slots available'}</div>
            </button>
          `;
        });
        
        html += `</div></div>`;
        detailsDiv.innerHTML = html;
      } else {
        // Single specialty - load timeslots directly
        const rtId = facility.specialties[0].rtId;
        loadTimeslotsForDoctor(doctorIndex, rtId, detailsDiv);
      }
    };

    window.selectSpecialty = function(doctorIndex, facilityIndex, specialtyIndex) {
      const doctor = doctors[doctorIndex];
      const rtId = doctor.facilities[facilityIndex].specialties[specialtyIndex].rtId;
      const detailsDiv = document.getElementById(`details-${doctorIndex}`);
      
      loadTimeslotsForDoctor(doctorIndex, rtId, detailsDiv);
    };

    async function loadTimeslotsForDoctor(index, rtId, detailsDiv) {
      detailsDiv.innerHTML = '<div class="loading">Loading timeslots...</div>';

      try {
        const response = await fetch(`${baseUrl}/api/timeslots`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ medicalFacilityDoctorSpecialityRTId: rtId })
        });

        timeslots = await response.json();
        renderTimeslotsInline(index);
      } catch (err) {
        detailsDiv.innerHTML = `<div class="error">Failed to load timeslots: ${err.message}</div>`;
      }
    }

    window.selectPatient = async function(index, phone) {
      const patient = window.patientsData[index];
      
      // Show loading indicator
      document.getElementById('otp-section').innerHTML = `
        <div class="loading" style="text-align: center; padding: 40px; color: #fff;">
          <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
          <div style="font-size: 18px; font-weight: 600;">Reserving appointment...</div>
          <div style="color: #94a3b8; margin-top: 8px;">Please wait</div>
        </div>
      `;
      
      try {
        const response = await fetch(`${baseUrl}/api/appointments/reserve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            timeslotRTId: selectedTimeslot.timeslotId,
            patientId: patient.patientId,
            mobileNumber: phone
          })
        });
        const data = await response.json();
        
        if (data.success) {
          showSuccess();
        } else {
          alert('Booking failed: ' + (data.message || 'Unknown error'));
          loadPatients(phone, currentSessionId); // Reload patient list on error
        }
      } catch (err) {
        alert('Error: ' + err.message);
        loadPatients(phone, currentSessionId); // Reload patient list on error
      }
    };
    
    function showSuccess() {
      const doctorName = selectedDoctor.doctorName || selectedDoctor.name || 'the doctor';
      
      container.innerHTML = `
        <div class="header">
          <img src="https://e-tabeb-chat-gpt-p.vercel.app/etabeb-logo.png?v=2" alt="eTabeb" class="logo" style="height: 60px; width: auto; margin: 0 auto 16px; display: block;" />
          <h1>Booking Confirmed!</h1>
        </div>
        <div class="content" style="text-align: center; padding: 40px 20px;">
          <div style="font-size: 64px; margin-bottom: 24px;">‚úÖ</div>
          <h2 style="color: #3EBFA5; font-size: 24px; font-weight: 700; margin-bottom: 16px;">Success!</h2>
          <div style="color: rgba(255, 255, 255, 0.9); font-size: 16px; line-height: 1.6; margin-bottom: 24px;">
            Your appointment with <strong>${doctorName}</strong><br/>
            on <strong>${selectedTimeslot.date}</strong> at <strong>${selectedTimeslot.time}</strong><br/>
            has been successfully booked.
          </div>
          <div style="background: rgba(62, 191, 165, 0.1); border: 1px solid rgba(62, 191, 165, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
            <div style="color: #3EBFA5; font-size: 14px; font-weight: 600; margin-bottom: 8px;">What's Next?</div>
            <div style="color: rgba(255, 255, 255, 0.8); font-size: 14px;">You will receive a confirmation message shortly. Please arrive 10 minutes before your appointment time.</div>
          </div>
          <button onclick="location.reload()" style="padding: 16px 32px; font-size: 16px; font-weight: 700; background: #3EBFA5; border: none; border-radius: 12px; color: #fff; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#35a892'" onmouseout="this.style.background='#3EBFA5'">Book Another Appointment</button>
        </div>
      `;
    }
    
    // Initialize
    async function initializeWidget() {
      await fetchCountryCodes();
      
      console.log('=== WIDGET INITIALIZATION ===');
      console.log('window.WIDGET_PARAMS:', window.WIDGET_PARAMS);
      console.log('window.PRELOADED_DOCTORS_DATA exists:', !!window.PRELOADED_DOCTORS_DATA);
      console.log('window.PRELOADED_DOCTORS_DATA:', window.PRELOADED_DOCTORS_DATA);
      console.log('preloadedResults flag:', window.WIDGET_PARAMS?.preloadedResults);
      
      // Resolve searchText - handle template placeholder case
      let searchText = window.WIDGET_PARAMS?.searchText || '';
      console.log('Initial searchText:', searchText);
      
      if (!searchText || isTemplatePlaceholder(searchText)) {
        console.log('‚ö†Ô∏è searchText is empty or placeholder, calling get_search_context...');
        try {
          const resolvedSearchText = await getSearchTextFromMcpContext();
          if (resolvedSearchText) {
            searchText = resolvedSearchText;
            window.WIDGET_PARAMS = window.WIDGET_PARAMS || {};
            window.WIDGET_PARAMS.searchText = searchText;
            console.log('‚úÖ Resolved searchText from MCP context:', searchText);
            
            // Update Arabic mode with the resolved searchText
            updateArabicMode(searchText);
          } else {
            console.log('‚ùå Could not resolve searchText from MCP context');
          }
        } catch (err) {
          console.error('‚ùå Error calling get_search_context:', err);
          // Continue anyway - we'll show search UI if no data
        }
      }
      
      // Check if we have preloaded doctor results using normalized helper
      const preloaded = getPreloadedDoctors();
      if (preloaded.length > 0) {
        console.log('‚úÖ Displaying preloaded doctor results');
        doctors = preloaded;
        console.log('Loaded doctors:', doctors.length);
        console.log('First doctor:', doctors[0]);
        
        // Show doctor cards immediately - Booking.com style
        renderDoctorResults();
      } else if (searchText && searchText.trim()) {
        // No preloaded doctors but we have a valid searchText - fetch and render cards
        console.log('üì° Fetching doctors for:', searchText);
        
        // Show loading state
        container.innerHTML = '<div class="loading" style="text-align: center; padding: 40px; color: #fff;">Loading doctors...</div>';
        
        try {
          doctors = await searchDoctorsFromApi(searchText);
          console.log('‚úÖ Fetched doctors:', doctors.length);
          
          if (doctors.length > 0) {
            renderDoctorResults();
          } else {
            container.innerHTML = '<div class="loading" style="text-align: center; padding: 40px; color: #fff;">No doctors found for ' + searchText + '</div>';
          }
        } catch (e) {
          console.error('‚ùå Error fetching doctors:', e);
          container.innerHTML =
            `<p style="color: #d32f2f; text-align: center; padding: 40px;">Error: ${e.message}</p>`;
        }
      } else {
        // No preloaded doctors and no searchText - show search UI
        console.log('‚ÑπÔ∏è No preloaded doctors or searchText, showing search UI');
        renderSearchUI();
      }
    }
    
    initializeWidget();
  </script>
</body>
</html>
