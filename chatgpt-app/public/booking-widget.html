<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>eTabeb Booking</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a2332;
      overflow-y: auto;
      overflow-x: hidden;
      color: #fff;
    }
    
    #booking-container {
      width: 100%;
      min-height: 100vh;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      padding: 24px 0;
      background: #1a2332;
      border-bottom: 1px solid #2d3748;
    }
    
    .logo {
      width: 140px;
      height: auto;
      margin-bottom: 12px;
    }
    
    .header h1 {
      color: #3EBFA5;
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .header p {
      color: #94a3b8;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #2d3748;
      padding: 6px 14px;
      border-radius: 20px;
    }
    
    .content {
      background: #1a2332;
      padding: 24px;
      max-width: 900px;
      margin: 0 auto;
    }
    
    .search-box {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    input[type="text"], input[type="tel"] {
      flex: 1;
      padding: 14px 16px;
      border: 1px solid #2d3748;
      border-radius: 12px;
      font-size: 15px;
      background: #2d3748;
      color: #fff;
      transition: all 0.3s;
    }
    
    input:focus {
      outline: none;
      border-color: #3EBFA5;
      background: #374151;
    }
    
    input::placeholder {
      color: #64748b;
    }
    
    .btn {
      padding: 14px 28px;
      background: #1976B2;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.3s;
    }
    
    .btn:hover {
      background: #1565C0;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(25, 118, 178, 0.3);
    }
    
    .btn-secondary {
      background: #f5f5f5;
      color: #333;
      padding: 10px 20px;
      font-size: 14px;
    }
    
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    
    .doctor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    
    .doctor-card {
      display: flex;
      gap: 16px;
      padding: 20px;
      border: 1px solid #2d3748;
      border-radius: 16px;
      background: #243447;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .doctor-card:hover {
      border-color: #3EBFA5;
      background: #2d3f54;
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(62, 191, 165, 0.25);
    }
    
    .doctor-card img {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      object-fit: cover;
      flex-shrink: 0;
      border: 2px solid #2d3748;
    }
    
    .doctor-info {
      flex: 1;
      min-width: 0;
    }
    
    .doctor-name {
      font-weight: 700;
      color: #fff;
      font-size: 17px;
      margin-bottom: 6px;
      line-height: 1.3;
    }
    
    .doctor-specialty {
      color: #3EBFA5;
      font-size: 14px;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .doctor-facility {
      color: #94a3b8;
      font-size: 13px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .doctor-meta {
      display: flex;
      gap: 16px;
      align-items: center;
      font-size: 13px;
      margin-top: 4px;
    }
    
    .doctor-rating {
      color: #fbbf24;
      display: flex;
      align-items: center;
      gap: 4px;
      background: rgba(251, 191, 36, 0.1);
      padding: 4px 10px;
      border-radius: 8px;
      font-weight: 600;
    }
    
    .doctor-price {
      color: #3EBFA5;
      font-weight: 700;
      font-size: 16px;
    }
    
    .doctor-availability {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(62, 191, 165, 0.15);
      color: #3EBFA5;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #2d3748;
    }
    
    .results-header h3 {
      color: #fff;
      font-size: 20px;
      font-weight: 700;
    }
    
    .results-count {
      color: #94a3b8;
      font-size: 14px;
      background: #2d3748;
      padding: 6px 14px;
      border-radius: 20px;
    }
    
    .doctor-accordion {
      margin-bottom: 16px;
      border-radius: 16px;
      overflow: hidden;
      background: #243447;
      border: 1px solid #2d3748;
      transition: all 0.3s;
    }
    
    .doctor-accordion:hover {
      border-color: #3EBFA5;
    }
    
    .doctor-details {
      background: #1a2332;
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        max-height: 0;
      }
      to {
        opacity: 1;
        max-height: 1000px;
      }
    }
    
    .date-btn {
      padding: 12px 16px;
      background: #243447;
      border: 1px solid #2d3748;
      border-radius: 12px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 120px;
      text-align: center;
    }
    
    .date-btn:hover {
      background: #2d3f54;
      border-color: #3EBFA5;
    }
    
    .date-btn.active {
      background: #3EBFA5;
      border-color: #3EBFA5;
    }
    
    .date-group {
      margin-bottom: 24px;
    }
    
    .date-accordion {
      margin-bottom: 12px;
    }
    
    .date-header-btn {
      width: 100%;
      padding: 16px;
      background: #243447;
      border: 1px solid #2d3748;
      border-radius: 12px;
      color: #fff;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
      font-size: 15px;
      font-weight: 600;
    }
    
    .date-header-btn:hover {
      background: #2d3f54;
      border-color: #3EBFA5;
    }
    
    .date-header-btn.active {
      background: #3EBFA5;
      border-color: #3EBFA5;
      border-radius: 12px 12px 0 0;
    }
    
    .date-content {
      display: none;
      background: #243447;
      border: 1px solid #2d3748;
      border-top: none;
      border-radius: 0 0 12px 12px;
      padding: 16px;
    }
    
    .date-content.active {
      display: block;
    }
    
    .timeslot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .timeslot-card {
      padding: 12px;
      border: 1px solid #2d3748;
      border-radius: 8px;
      background: #243447;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }
    
    .timeslot-card:hover {
      border-color: #3EBFA5;
      background: #2d3f54;
      transform: translateY(-2px);
    }
    
    .timeslot-time {
      font-weight: 600;
      color: #fff;
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .patient-card {
      padding: 14px;
      border: 2px solid #E0E0E0;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .patient-card:hover, .patient-card.selected {
      border-color: #1976B2;
      background: #F5F9FC;
    }
    
    .patient-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    
    .patient-id {
      color: #888;
      font-size: 13px;
    }
    
    .success-message {
      text-align: center;
      padding: 40px 20px;
    }
    
    .success-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
    
    .success-title {
      color: #3EBFA5;
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .success-text {
      color: #666;
      font-size: 15px;
    }
    
    .loading {
      text-align: center;
      color: #94a3b8;
      padding: 40px;
      font-size: 16px;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .error {
      background: #FEE;
      border: 2px solid #F88;
      color: #C33;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 16px;
    }
    
    .security-note {
      background: #F0F9FF;
      border-left: 4px solid #1976B2;
      padding: 12px 16px;
      margin-bottom: 20px;
      border-radius: 8px;
      font-size: 13px;
      color: #666;
    }
  </style>
</head>
<body>
  <div id="booking-container"></div>
  
  <script>
    console.log('üîÑ Widget Version: 2026-01-30-22:27 - Fixed Country Mapping');
    const container = document.getElementById('booking-container');
    const baseUrl = '{{BOOKING_APP_URL}}';
    
    // State management
    let doctors = [];
    let selectedDoctor = null;
    let timeslots = [];
    let currentSessionId = null; // Store sessionId globally
    let countryCodes = []; // Store country codes from API
    
    // Fetch country codes on load
    async function fetchCountryCodes() {
      try {
        const response = await fetch('https://etapisd.etabeb.com/api/AI/CountryListForContact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const data = await response.json();
        console.log('Country API Response:', data);
        
        // The API returns an array directly
        if (Array.isArray(data)) {
          // Map API response to our format: value -> countryId, text -> countryKey, text1 -> countryName
          countryCodes = data.map(country => ({
            countryId: country.value,
            countryKey: country.text,
            countryName: country.text1 || country.text2
          }));
        } else {
          console.warn('Unexpected country data format:', data);
          countryCodes = [];
        }
        
        console.log('Country codes loaded:', countryCodes.length, 'countries');
        
        // If no countries loaded, use fallback
        if (countryCodes.length === 0) {
          console.warn('No countries from API, using fallback');
          countryCodes = [
            { countryId: 1, countryName: 'Saudi Arabia', countryKey: '+966' },
            { countryId: 2, countryName: 'UAE', countryKey: '+971' },
            { countryId: 3, countryName: 'Kuwait', countryKey: '+965' }
          ];
        }
      } catch (err) {
        console.error('Failed to load country codes:', err);
        // Fallback to default countries
        countryCodes = [
          { countryId: 1, countryName: 'Saudi Arabia', countryKey: '+966' },
          { countryId: 2, countryName: 'UAE', countryKey: '+971' },
          { countryId: 3, countryName: 'Kuwait', countryKey: '+965' }
        ];
      }
    }
    
    // Helper: Get doctor initials for avatar
    function getInitials(name) {
      return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    }
    
    // Helper: Generate avatar color
    function getAvatarColor(name) {
      const colors = ['#1976B2', '#3EBFA5', '#9C27B0', '#FF9800', '#E91E63'];
      const index = name.length % colors.length;
      return colors[index];
    }
    
    function renderDoctorResults() {
      const doctorCount = doctors.length;
      const searchText = window.WIDGET_PARAMS?.searchText || 'doctors';
      
      container.innerHTML = `
        <div class="header">
          <img src="https://e-tabeb-chat-gpt-p.vercel.app/etabeb-logo.png?v=2" alt="eTabeb" class="logo" style="height: 60px; width: auto; margin: 0 auto 16px; display: block;" />
          <h1>Book Appointment</h1>
        </div>
        <div class="content">
          <div class="results-header">
            <h3>Available ${searchText} Doctors</h3>
            <span class="results-count">${doctorCount} doctors found</span>
          </div>
          <div id="doctor-list"></div>
        </div>
      `;
      
      renderDoctorCards();
    }
    
    function renderDoctorCards() {
      const doctorList = document.getElementById('doctor-list');
      if (!doctorList) return;
      
      doctorList.innerHTML = doctors.map((doctor, index) => `
        <div class="doctor-accordion" id="doctor-${index}">
          <div class="doctor-card" onclick="toggleDoctorDetails(${index})">
            <div class="doctor-availability">${doctor.timeslotCount || 0} slots</div>
            <img src="${doctor.picURL01 || 'https://e-tabeb-chat-gpt-p.vercel.app/etabeb-logo.png'}" alt="${doctor.doctorName}" onerror="this.src='https://e-tabeb-chat-gpt-p.vercel.app/etabeb-logo.png'">
            <div class="doctor-info">
              <div class="doctor-name">${doctor.doctorName}</div>
              <div class="doctor-specialty">${doctor.medicalSpecialityText}</div>
              <div class="doctor-facility">üìç ${doctor.medicalFacilityName}</div>
              <div class="doctor-meta">
                <span class="doctor-rating">‚≠ê ${doctor.ratingAvg || doctor.ratingText || 'New'}</span>
                <span class="doctor-price">${doctor.priceRateMin || '0'} ${doctor.currencyCode}</span>
              </div>
            </div>
            <div style="margin-left: auto; color: #3EBFA5; font-size: 24px; transition: transform 0.3s;" class="expand-icon">‚Ä∫</div>
          </div>
          <div class="doctor-details" id="details-${index}" style="display: none;"></div>
        </div>
      `).join('');
    }
    
    function renderSearchUI() {
      container.innerHTML = `
        <div class="header">
          <img 
            src="https://e-tabeb-chat-gpt-p.vercel.app/etabeb-logo.png?v=2" 
            alt="eTabeb" 
            class="logo"
            style="height: 60px; width: auto; margin: 0 auto 16px; display: block;"
          />
          <h1>Book Appointment</h1>
        </div>
        <div class="content">
          <div style="background: #243447; border-radius: 16px; padding: 20px; margin-bottom: 24px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <div style="width: 40px; height: 40px; background: #3EBFA5; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">1</div>
              <h3 style="color: #fff; margin: 0; font-size: 18px;">Select Doctor</h3>
            </div>
            <div class="search-box">
              <input 
                type="text" 
                id="search-input" 
                placeholder="Search by name, specialty, or hospital..."
              />
              <button id="search-btn" class="btn">Search</button>
            </div>
          </div>
          <div id="results"></div>
        </div>
      `;
      
      document.getElementById('search-btn').onclick = handleSearch;
      document.getElementById('search-input').onkeypress = (e) => {
        if (e.key === 'Enter') handleSearch();
      };
    }
    
    async function handleSearch() {
      const searchText = document.getElementById('search-input').value.trim();
      if (!searchText) return;
      
      document.getElementById('results').innerHTML = '<div class="loading">Searching...</div>';
      
      try {
        // Call private search_doctors tool
        const result = await window.openai.callTool('search_doctors', {
          searchText: searchText,
          limit: 50
        });
        
        // Fetch doctors from API directly for structured data - fetch up to 50 results
        const response = await fetch(`${baseUrl}/api/doctors`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ SearchText: searchText, CityId: 1, limit: 50 })
        });
        doctors = await response.json();
        
        renderDoctors();
      } catch (err) {
        document.getElementById('results').innerHTML = `<p style="color: #d32f2f; text-align: center;">Error: ${err.message}</p>`;
      }
    }
    
    function renderDoctors() {
      if (!doctors || doctors.length === 0) {
        document.getElementById('results').innerHTML = '<div class="loading">No doctors found</div>';
        return;
      }
      
      const html = doctors.map(d => {
        const initials = getInitials(d.name);
        const avatarColor = getAvatarColor(d.name);
        const hasImage = d.image && d.image.trim() !== '';
        
        const avatarHtml = hasImage 
          ? `<img src="${d.image}" alt="${d.name}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; flex-shrink: 0;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
             <div style="width: 48px; height: 48px; border-radius: 50%; background: ${avatarColor}; display: none; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 16px; flex-shrink: 0;">
               ${initials}
             </div>`
          : `<div style="width: 48px; height: 48px; border-radius: 50%; background: ${avatarColor}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 16px; flex-shrink: 0;">
               ${initials}
             </div>`;
        
        return `
          <div class="doctor-card" onclick="selectDoctor('${d.id}')">
            <div style="display: flex; gap: 12px; margin-bottom: 12px;">
              ${avatarHtml}
              <div style="flex: 1; min-width: 0;">
                <div class="doctor-name">${d.name}</div>
                <div class="doctor-specialty">${d.specialty}</div>
              </div>
            </div>
            <div class="doctor-facility">üìç ${d.facility}</div>
            <div class="doctor-meta">
              <span class="doctor-rating">‚≠ê ${d.rating || '0'}</span>
              <span class="doctor-price">${d.price} ${d.currency}</span>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('results').innerHTML = `<div class="doctor-grid">${html}</div>`;
    }
    
    window.selectDoctor = async function(doctorId) {
      selectedDoctor = doctors.find(d => d.id === doctorId);
      if (!selectedDoctor) return;
      
      document.getElementById('results').innerHTML = '<p style="text-align: center; color: #666;">Loading timeslots...</p>';
      
      try {
        // Call private get_timeslots tool
        await window.openai.callTool('get_timeslots', {
          doctorId: doctorId
        });
        
        // Fetch timeslots from API
        const response = await fetch(`${baseUrl}/api/timeslots`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ medicalFacilityDoctorSpecialityRTId: doctorId })
        });
        timeslots = await response.json();
        
        renderTimeslots();
      } catch (err) {
        document.getElementById('results').innerHTML = `<p style="color: #d32f2f; text-align: center;">Error: ${err.message}</p>`;
      }
    };
    
    let selectedDate = null;
    
    function renderTimeslotsInline(doctorIndex) {
      const detailsDiv = document.getElementById(`details-${doctorIndex}`);
      if (!timeslots || timeslots.length === 0) {
        detailsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #94a3b8;">No available appointments</div>';
        return;
      }
      
      // Group timeslots by date
      const grouped = {};
      timeslots.forEach(slot => {
        if (!grouped[slot.date]) grouped[slot.date] = [];
        grouped[slot.date].push(slot);
      });
      
      const dates = Object.keys(grouped).slice(0, 5);
      if (!selectedDate && dates.length > 0) selectedDate = dates[0];
      
      const dateButtons = dates.map(date => `
        <button onclick="selectDate('${date}', ${doctorIndex})" class="date-btn ${date === selectedDate ? 'active' : ''}" id="date-btn-${date}">
          <div style="font-size: 12px; color: #94a3b8;">üìÖ</div>
          <div style="font-weight: 600; margin-top: 4px;">${date}</div>
          <div style="font-size: 11px; color: #94a3b8; margin-top: 2px;">${grouped[date].length} slots</div>
        </button>
      `).join('');
      
      const slots = grouped[selectedDate].map(slot => `
        <div class="timeslot-card" onclick="selectTimeslot(${slot.timeslotRTId}, '${slot.date}', '${slot.time}', ${doctorIndex})">
          <div class="timeslot-time">${slot.time}</div>
        </div>
      `).join('');
      
      detailsDiv.innerHTML = `
        <div style="padding: 20px; background: #1a2332; border-top: 1px solid #2d3748;">
          <h4 style="color: #fff; margin-bottom: 16px; font-size: 16px;">Select Date</h4>
          <div style="display: flex; gap: 12px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 8px;">
            ${dateButtons}
          </div>
          <h4 style="color: #fff; margin-bottom: 16px; font-size: 16px;">Available Times</h4>
          <div class="timeslot-grid" id="timeslot-grid-${doctorIndex}">${slots}</div>
        </div>
      `;
    }
    
    window.selectDate = function(date, doctorIndex) {
      selectedDate = date;
      document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`date-btn-${date}`).classList.add('active');
      
      const grouped = {};
      timeslots.forEach(slot => {
        if (!grouped[slot.date]) grouped[slot.date] = [];
        grouped[slot.date].push(slot);
      });
      
      const slots = grouped[date].map(slot => `
        <div class="timeslot-card" onclick="selectTimeslot(${slot.timeslotRTId}, '${slot.date}', '${slot.time}', ${doctorIndex})">
          <div class="timeslot-time">${slot.time}</div>
        </div>
      `).join('');
      
      document.getElementById(`timeslot-grid-${doctorIndex}`).innerHTML = slots;
    };
    
    let selectedTimeslot = null;
    
    window.selectTimeslot = function(timeslotId, date, time, doctorIndex) {
      selectedTimeslot = { timeslotId, date, time };
      renderBookingFormInline(doctorIndex);
    };
    
    function renderBookingFormInline(doctorIndex) {
      const detailsDiv = document.getElementById(`details-${doctorIndex}`);
      const header = `
        <div style="background: #243447; border-radius: 16px; padding: 20px; margin-bottom: 24px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <div style="width: 40px; height: 40px; background: #3EBFA5; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">3</div>
            <h3 style="color: #fff; margin: 0; font-size: 18px;">Complete Booking</h3>
          </div>
          <div style="color: #94a3b8; font-size: 14px;">
            <p style="margin: 0 0 4px 0;"><strong style="color: #fff;">${selectedDoctor.name}</strong></p>
            <p style="margin: 0 0 4px 0;">${selectedDoctor.specialty} ‚Ä¢ ${selectedDoctor.facility}</p>
            <p style="margin: 0; color: #3EBFA5;">üìÖ ${selectedTimeslot.date} at ${selectedTimeslot.time}</p>
          </div>
        </div>
      `;
      
      detailsDiv.innerHTML = `
        <div style="padding: 20px; background: #1a2332; border-top: 1px solid #2d3748;">
          ${header}
          <div class="security-note">
            üîí Your information is secure. We'll verify your phone number and complete the booking.
          </div>
          <div class="form-group">
            <label class="form-label" style="color: #fff; display: block; margin-bottom: 8px; font-weight: 500;">Phone Number</label>
            <div style="display: flex; gap: 12px;">
              <select id="country-select" style="padding: 14px 16px; border: 1px solid #2d3748; border-radius: 12px; background: #2d3748; color: #fff; font-size: 15px; min-width: 140px;">
                ${countryCodes.map(c => `<option value="${c.countryId}">${c.countryKey}</option>`).join('')}
              </select>
              <input type="tel" id="phone-input" placeholder="5XXXXXXXX" style="flex: 1;" />
            </div>
          </div>
          <button id="send-otp-btn" onclick="sendOTP()" class="btn" style="width: 100%; margin-bottom: 12px;">Send OTP</button>
          <div id="otp-section" style="display: none;"></div>
        </div>
      `;
    }
    
    window.sendOTP = async function() {
      const phone = document.getElementById('phone-input').value.trim();
      const countryId = document.getElementById('country-select').value;
      const btn = document.getElementById('send-otp-btn');
      
      if (!phone) {
        console.error('Please enter your phone number');
        return;
      }
      
      btn.disabled = true;
      btn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 8px;"><svg width="16" height="16" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke="white" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"/></svg> Sending...</span>';
      
      try {
        // Only search user if we don't have a sessionId yet
        if (!currentSessionId) {
          const searchRes = await fetch(`${baseUrl}/api/auth/search-user`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mobileNumber: phone, countryId: parseInt(countryId) })
          });
          const searchData = await searchRes.json();
          console.log('Search user response:', searchData);
          
          // Extract sessionId from search response and store globally
          currentSessionId = searchData.sessionId || searchData.userSessionId || searchData.userData?.userSessionId || searchData.userData?.usersSessionId;
          console.log('Extracted sessionId:', currentSessionId);
        } else {
          console.log('Using existing sessionId:', currentSessionId);
        }
        
        // Then send OTP
        const otpRes = await fetch(`${baseUrl}/api/auth/send-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mobileNumber: phone, countryId: parseInt(countryId) })
        });
        const otpData = await otpRes.json();
        
        if (otpData.signOTPId) {
          showOTPInput(otpData.signOTPId, phone);
        } else {
          btn.disabled = false;
          btn.innerHTML = 'Send OTP';
          console.error('Failed to send OTP. Please try again.');
        }
      } catch (err) {
        btn.disabled = false;
        btn.innerHTML = 'Send OTP';
        console.error('Error: ' + err.message);
      }
    };
    
    function showOTPInput(signOTPId, phone) {
      document.getElementById('send-otp-btn').style.display = 'none';
      document.getElementById('otp-section').style.display = 'block';
      document.getElementById('otp-section').innerHTML = `
        <div class="form-group">
          <label class="form-label" style="color: #fff; display: block; margin-bottom: 8px; font-weight: 500;">Enter OTP Code</label>
          <input type="text" id="otp-input" placeholder="Enter 6-digit code" maxlength="6" style="width: 100%;" />
        </div>
        <button onclick="verifyOTP('${signOTPId}', '${phone}')" class="btn" style="width: 100%;">Verify & Continue</button>
      `;
    }
    
    window.verifyOTP = async function(signOTPId, phone) {
      const otpCode = document.getElementById('otp-input').value.trim();
      if (!otpCode) {
        console.error('Please enter OTP code');
        return;
      }
      
      try {
        const response = await fetch(`${baseUrl}/api/auth/verify-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signOTPId, signOTPCode: otpCode })
        });
        const data = await response.json();
        
        console.log('OTP Verify Response:', data);
        console.log('sessionId from verify API:', data.sessionId);
        console.log('currentSessionId (from search-user):', currentSessionId);
        
        if (data.isVerified) {
          // DO NOT update currentSessionId - keep using the one from search-user API
          // The verify-otp API returns signOTPId, not the user's sessionId
          console.log('OTP verified! Using sessionId from search-user:', currentSessionId);
          loadPatients(phone, currentSessionId);
        } else {
          console.error('Invalid OTP:', data.message || 'Please try again.');
          alert(data.message || 'Invalid OTP. Please try again.');
        }
      } catch (err) {
        console.error('Error verifying OTP:', err.message);
        alert('Error verifying OTP. Please try again.');
      }
    };
    
    async function loadPatients(phone, sessionId) {
      try {
        console.log('Loading patients with sessionId:', sessionId);
        const response = await fetch(`${baseUrl}/api/auth/patients`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: sessionId, mobileNumber: phone })
        });
        const patients = await response.json();
        console.log('Patients response:', patients);
        
        showPatientSelection(patients, phone);
      } catch (err) {
        console.error('Error loading patients: ' + err.message);
      }
    }
    
    function showPatientSelection(patients, phone) {
      if (!patients || patients.length === 0) {
        document.getElementById('otp-section').innerHTML = `
          <div style="color: #fff; text-align: center; padding: 20px;">No patients found for this number.</div>
        `;
        return;
      }
      
      const patientCards = patients.map((p, i) => `
        <div class="patient-card" onclick="selectPatient(${i}, '${phone}')" style="padding: 16px; background: #243447; border: 1px solid #2d3748; border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#3EBFA5'" onmouseout="this.style.borderColor='#2d3748'">
          <div style="font-weight: 600; color: #fff; font-size: 16px; margin-bottom: 4px;">${p.patientName}</div>
          <div style="color: #94a3b8; font-size: 14px;">ID: ${p.residentIdentities || p.patientId || 'N/A'}</div>
        </div>
      `).join('');
      
      document.getElementById('otp-section').innerHTML = `
        <div class="form-group">
          <label class="form-label" style="color: #fff; display: block; margin-bottom: 12px; font-weight: 500; font-size: 16px;">Select Patient</label>
          ${patientCards}
        </div>
      `;
      
      window.patientsData = patients;
      window.phoneNumber = phone;
    }
    
    window.selectPatient = async function(index, phone) {
      const patient = window.patientsData[index];
      
      // Show loading indicator
      document.getElementById('otp-section').innerHTML = `
        <div class="loading" style="text-align: center; padding: 40px; color: #fff;">
          <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
          <div style="font-size: 18px; font-weight: 600;">Reserving appointment...</div>
          <div style="color: #94a3b8; margin-top: 8px;">Please wait</div>
        </div>
      `;
      
      try {
        const response = await fetch(`${baseUrl}/api/appointments/reserve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            timeslotRTId: selectedTimeslot.timeslotId,
            patientId: patient.patientId,
            mobileNumber: phone
          })
        });
        const data = await response.json();
        
        if (data.success) {
          showSuccess();
        } else {
          alert('Booking failed: ' + (data.message || 'Unknown error'));
          loadPatients(phone, currentSessionId); // Reload patient list on error
        }
      } catch (err) {
        alert('Error: ' + err.message);
        loadPatients(phone, currentSessionId); // Reload patient list on error
      }
    };
    
    function showSuccess() {
      document.getElementById('results').innerHTML = `
        <div class="success-message">
          <div class="success-icon">‚úÖ</div>
          <div class="success-title">Booking Confirmed!</div>
          <div class="success-text">
            Your appointment with ${selectedDoctor.name}<br/>
            on ${selectedTimeslot.date} at ${selectedTimeslot.time}<br/>
            has been successfully booked.
          </div>
          <button onclick="renderSearchUI()" class="btn" style="margin-top: 24px;">Book Another Appointment</button>
        </div>
      `;
    }
    
    // Initialize
    async function initializeWidget() {
      await fetchCountryCodes();
      
      console.log('=== WIDGET INITIALIZATION ===');
      console.log('window.WIDGET_PARAMS:', window.WIDGET_PARAMS);
      console.log('window.PRELOADED_DOCTORS_DATA exists:', !!window.PRELOADED_DOCTORS_DATA);
      console.log('window.PRELOADED_DOCTORS_DATA:', window.PRELOADED_DOCTORS_DATA);
      console.log('preloadedResults flag:', window.WIDGET_PARAMS?.preloadedResults);
      
      // Check if we have preloaded doctor results
      if (window.PRELOADED_DOCTORS_DATA && window.PRELOADED_DOCTORS_DATA.length > 0) {
        console.log('‚úÖ Displaying preloaded doctor results');
        
        // Use preloaded doctor data directly
        doctors = window.PRELOADED_DOCTORS_DATA;
        console.log('Loaded doctors:', doctors.length);
        console.log('First doctor:', doctors[0]);
        
        // Show doctor cards immediately - Booking.com style
        renderDoctorResults();
      } else {
        // Fallback to auto-search if no preloaded results
        const autoSearchText = window.WIDGET_PARAMS?.searchText || '';
        console.log('Widget initialized with search text:', autoSearchText);
        
        if (autoSearchText && autoSearchText.trim()) {
          console.log('Auto-searching for:', autoSearchText);
          renderSearchUI();
          setTimeout(() => {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
              searchInput.value = autoSearchText;
              handleSearch();
            }
          }, 300);
        } else {
          renderSearchUI();
        }
      }
    }
    
    initializeWidget();
  </script>
</body>
</html>
